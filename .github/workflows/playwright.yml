name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    strategy:
      matrix:
        env_name: [test, acceptance]

    steps:
      # ---------------- Checkout ----------------
      - uses: actions/checkout@v4

      # ---------------- Node setup ----------------
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*

      # ---------------- Install deps ----------------
      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      # ---------------- Run tests ----------------
      - name: Run Playwright tests
        id: run_tests
        run: |
          npx playwright test
          echo "TEST_EXIT_CODE=$?" >> $GITHUB_ENV
        env:
          test_env: ${{ matrix.env_name }}

      # ---------------- Generate Allure HTML ----------------
      - name: Generate Allure HTML Report
        run: |
          npx allure generate allure-results --clean -o allure-report

      # ---------------- Upload Allure Report as artifact ----------------
      - name: Upload Allure Report
        id: upload_report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.env_name }}
          path: allure-report/
          retention-days: 30

      # ---------------- Get download URL via GitHub API ----------------
      - name: Get artifact download link
        id: get_download_url
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENV_NAME: ${{ matrix.env_name }}
        run: |
          # 1. List artifacts for this run
          RESPONSE=$(curl -s \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}/artifacts")

          # 2. Find the artifact ID by name
          ARTIFACT_ID=$(echo "$RESPONSE" | jq -r \
            ".artifacts[] | select(.name==\"allure-report-${ENV_NAME}\") | .id")

          # 3. GitHub API gives a *time-limited* link for the actual download
          DOWNLOAD_URL=$(curl -s -X GET \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/artifacts/${ARTIFACT_ID}/zip" \
            -I | grep -i 'Location:' | awk '{print $2}' | tr -d '\r')

          echo "ARTIFACT_DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV

      # ---------------- Slack Notification ----------------
      - name: Slack Notification
        if: always()
        env:
          ENV_NAME: ${{ matrix.env_name }}
          EXIT_CODE: ${{ env.TEST_EXIT_CODE }}
          DOWNLOAD_URL: ${{ env.ARTIFACT_DOWNLOAD_URL }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          if [ "$EXIT_CODE" -eq 0 ]; then
            STATUS=":white_check_mark: Playwright Tests Passed"
          else
            STATUS=":x: Playwright Tests Failed"
          fi

          curl -X POST -H "Content-type: application/json" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            --data "{
              \"channel\": \"#automation-testresults\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {\"type\": \"mrkdwn\", \"text\": \"${STATUS}\\n*Environment:* ${ENV_NAME}\"}
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {\"type\": \"mrkdwn\", \"text\": \"*Repository:*\\n${GITHUB_REPOSITORY}\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Branch:*\\n${GITHUB_REF_NAME}\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Triggered by:*\\n${GITHUB_ACTOR}\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\\n${GITHUB_SHA}\"}
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {\"type\": \"mrkdwn\", \"text\": \":page_facing_up: Download Allure report: <${DOWNLOAD_URL}|Click Here>\\n:link: View Workflow: <https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|View Workflow>\"}
                }
              ]
            }" \
            https://slack.com/api/chat.postMessage

      # ---------------- Fail job if tests failed ----------------
      - name: Fail job if tests failed
        if: env.TEST_EXIT_CODE != '0'
        run: exit 1
